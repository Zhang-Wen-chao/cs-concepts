# Transport Layer - ä¼ è¾“å±‚

> å¦‚ä½•ä¿è¯æ•°æ®å¯é ä¼ è¾“ï¼ŸTCPå’ŒUDPæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

## ğŸ¯ ä¼ è¾“å±‚çš„ä½œç”¨

**ä¼ è¾“å±‚**æä¾›ç«¯åˆ°ç«¯çš„æ•°æ®ä¼ è¾“æœåŠ¡ï¼Œæ˜¯åº”ç”¨ç¨‹åºä¹‹é—´é€šä¿¡çš„æ¡¥æ¢ã€‚

```
åŠŸèƒ½ï¼š
1. ç«¯åˆ°ç«¯é€šä¿¡ï¼šè¿›ç¨‹åˆ°è¿›ç¨‹
2. å¯é ä¼ è¾“ï¼šç¡®ä¿æ•°æ®å®Œæ•´æ— è¯¯
3. æµé‡æ§åˆ¶ï¼šé˜²æ­¢å‘é€æ–¹è¿‡å¿«
4. æ‹¥å¡æ§åˆ¶ï¼šé˜²æ­¢ç½‘ç»œè¿‡è½½
5. å¤ç”¨ä¸åˆ†ç”¨ï¼šå¤šä¸ªåº”ç”¨å…±äº«ç½‘ç»œ

æ•°æ®å•ä½ï¼šæ®µï¼ˆSegmentï¼‰

ç±»æ¯”ï¼š
ä¼ è¾“å±‚ = å¿«é€’æœåŠ¡
ç«¯å£å· = é—¨ç‰Œå·
TCP = ä¿è¯é€è¾¾çš„å¿«é€’
UDP = æ™®é€šä¿¡ä»¶
```

---

## ğŸ”Œ ç«¯å£å·

### ç«¯å£å·çš„ä½œç”¨

```
ç«¯å£å·ï¼š16ä½ï¼ˆ0-65535ï¼‰

ä½œç”¨ï¼šåŒºåˆ†åŒä¸€ä¸»æœºä¸Šçš„ä¸åŒåº”ç”¨

åœ°å€ = IPåœ°å€ + ç«¯å£å·
ä¾‹å­ï¼š192.168.1.100:8080

IPåœ°å€ï¼šæ ‡è¯†ä¸»æœº
ç«¯å£å·ï¼šæ ‡è¯†ä¸»æœºä¸Šçš„åº”ç”¨
```

### ç«¯å£å·åˆ†ç±»

```
çŸ¥åç«¯å£ï¼ˆWell-Known Portsï¼‰ï¼š0-1023
- 21ï¼šFTP
- 22ï¼šSSH
- 23ï¼šTelnet
- 25ï¼šSMTPï¼ˆé‚®ä»¶å‘é€ï¼‰
- 53ï¼šDNS
- 80ï¼šHTTP
- 443ï¼šHTTPS
- 3306ï¼šMySQL
- 6379ï¼šRedis

æ³¨å†Œç«¯å£ï¼ˆRegistered Portsï¼‰ï¼š1024-49151
- åº”ç”¨ç¨‹åºæ³¨å†Œä½¿ç”¨

åŠ¨æ€ç«¯å£ï¼ˆDynamic Portsï¼‰ï¼š49152-65535
- å®¢æˆ·ç«¯ä¸´æ—¶ä½¿ç”¨
```

### æŸ¥çœ‹ç«¯å£

```bash
# æŸ¥çœ‹æ‰€æœ‰ç«¯å£
netstat -an

# æŸ¥çœ‹ç›‘å¬ç«¯å£
netstat -ln

# æŸ¥çœ‹ç‰¹å®šç«¯å£
netstat -an | grep 8080

# LinuxæŸ¥çœ‹ç«¯å£å ç”¨
lsof -i :8080

# æŸ¥çœ‹è¿›ç¨‹çš„ç«¯å£
ps aux | grep nginx
```

---

## ğŸ“¦ UDPåè®®

### UDPç‰¹ç‚¹

```
UDP (User Datagram Protocol) - ç”¨æˆ·æ•°æ®æŠ¥åè®®

ç‰¹ç‚¹ï¼š
âœ… æ— è¿æ¥ï¼šä¸éœ€è¦å»ºç«‹è¿æ¥
âœ… å¿«é€Ÿï¼šæ²¡æœ‰æ¡æ‰‹å’Œç¡®è®¤
âœ… ç®€å•ï¼šå¤´éƒ¨å¼€é”€å°ï¼ˆ8å­—èŠ‚ï¼‰
âœ… æ”¯æŒå¹¿æ’­å’Œå¤šæ’­
âŒ ä¸å¯é ï¼šä¸ä¿è¯é€è¾¾
âŒ æ— åºï¼šå¯èƒ½ä¹±åºåˆ°è¾¾
âŒ æ— æµé‡æ§åˆ¶
âŒ æ— æ‹¥å¡æ§åˆ¶

é€‚ç”¨åœºæ™¯ï¼š
- å®æ—¶è§†é¢‘/è¯­éŸ³ï¼ˆå®å¯ä¸¢åŒ…ä¹Ÿä¸è¦å»¶è¿Ÿï¼‰
- DNSæŸ¥è¯¢ï¼ˆå¿«é€Ÿå“åº”ï¼‰
- ç½‘ç»œæ¸¸æˆï¼ˆå®æ—¶æ€§é‡è¦ï¼‰
- ç‰©è”ç½‘ï¼ˆç®€å•è®¾å¤‡ï¼‰
```

### UDPæŠ¥æ–‡æ ¼å¼

```
UDPæŠ¥å¤´ï¼š8å­—èŠ‚

 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          æºç«¯å£               â”‚          ç›®æ ‡ç«¯å£             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚          é•¿åº¦                 â”‚          æ ¡éªŒå’Œ               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚                           æ•°æ®                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Pythonå®ç°UDPé€šä¿¡

```python
import socket

# UDPæœåŠ¡å™¨
def udp_server(host='127.0.0.1', port=9999):
    """UDPæœåŠ¡å™¨"""
    # åˆ›å»ºsocket
    sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)

    # ç»‘å®šåœ°å€
    sock.bind((host, port))
    print(f"UDPæœåŠ¡å™¨å¯åŠ¨åœ¨ {host}:{port}")

    while True:
        # æ¥æ”¶æ•°æ®ï¼ˆæœ€å¤§1024å­—èŠ‚ï¼‰
        data, addr = sock.recvfrom(1024)
        print(f"æ”¶åˆ°æ¥è‡ª {addr} çš„æ•°æ®: {data.decode()}")

        # å‘é€å“åº”
        response = f"Echo: {data.decode()}"
        sock.sendto(response.encode(), addr)

# UDPå®¢æˆ·ç«¯
def udp_client(host='127.0.0.1', port=9999):
    """UDPå®¢æˆ·ç«¯"""
    # åˆ›å»ºsocket
    sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)

    try:
        # å‘é€æ•°æ®ï¼ˆä¸éœ€è¦connectï¼‰
        message = "Hello, UDP!"
        sock.sendto(message.encode(), (host, port))
        print(f"å‘é€: {message}")

        # æ¥æ”¶å“åº”
        data, addr = sock.recvfrom(1024)
        print(f"æ”¶åˆ°å“åº”: {data.decode()}")
    finally:
        sock.close()

# ä½¿ç”¨
if __name__ == "__main__":
    import sys

    if len(sys.argv) > 1 and sys.argv[1] == 'server':
        udp_server()
    else:
        udp_client()
```

---

## ğŸ”’ TCPåè®®

### TCPç‰¹ç‚¹

```
TCP (Transmission Control Protocol) - ä¼ è¾“æ§åˆ¶åè®®

ç‰¹ç‚¹ï¼š
âœ… é¢å‘è¿æ¥ï¼šä¸‰æ¬¡æ¡æ‰‹å»ºç«‹è¿æ¥
âœ… å¯é ä¼ è¾“ï¼šä¿è¯æ•°æ®é€è¾¾
âœ… æœ‰åºï¼šæŒ‰åºåˆ°è¾¾
âœ… æµé‡æ§åˆ¶ï¼šæ»‘åŠ¨çª—å£
âœ… æ‹¥å¡æ§åˆ¶ï¼šé˜²æ­¢ç½‘ç»œæ‹¥å¡
âœ… å…¨åŒå·¥ï¼šåŒå‘é€šä¿¡
âŒ æ…¢ï¼šæ¡æ‰‹ã€ç¡®è®¤ã€é‡ä¼ 
âŒ å¼€é”€å¤§ï¼šå¤´éƒ¨20å­—èŠ‚+

é€‚ç”¨åœºæ™¯ï¼š
- ç½‘é¡µæµè§ˆï¼ˆHTTPï¼‰
- æ–‡ä»¶ä¼ è¾“ï¼ˆFTPï¼‰
- é‚®ä»¶ï¼ˆSMTP/POP3ï¼‰
- è¿œç¨‹ç™»å½•ï¼ˆSSHï¼‰
- å‡ ä¹æ‰€æœ‰éœ€è¦å¯é æ€§çš„åœºæ™¯
```

### TCPæŠ¥æ–‡æ ¼å¼

```
TCPæŠ¥å¤´ï¼š20-60å­—èŠ‚

 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          æºç«¯å£               â”‚          ç›®æ ‡ç«¯å£             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                        åºåˆ—å·ï¼ˆSequence Numberï¼‰              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                      ç¡®è®¤å·ï¼ˆAcknowledgment Numberï¼‰          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”¬â”€â”¬â”€â”¬â”€â”¬â”€â”¬â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚å¤´é•¿åº¦â”‚ä¿ç•™â”‚Uâ”‚Aâ”‚Pâ”‚Râ”‚Sâ”‚Fâ”‚             çª—å£å¤§å°                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”´â”€â”´â”€â”´â”€â”´â”€â”´â”€â”´â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚          æ ¡éªŒå’Œ           â”‚          ç´§æ€¥æŒ‡é’ˆ                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                        é€‰é¡¹ï¼ˆå¯é€‰ï¼‰                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å…³é”®å­—æ®µï¼š
- åºåˆ—å·ï¼šæ•°æ®çš„å­—èŠ‚ç¼–å·
- ç¡®è®¤å·ï¼šæœŸæœ›æ”¶åˆ°çš„ä¸‹ä¸€ä¸ªå­—èŠ‚ç¼–å·
- æ ‡å¿—ä½ï¼š
  - SYNï¼šå»ºç«‹è¿æ¥
  - ACKï¼šç¡®è®¤
  - FINï¼šç»“æŸè¿æ¥
  - RSTï¼šé‡ç½®è¿æ¥
  - PSHï¼šæ¨é€æ•°æ®
  - URGï¼šç´§æ€¥æ•°æ®
- çª—å£å¤§å°ï¼šæµé‡æ§åˆ¶
```

---

## ğŸ¤ ä¸‰æ¬¡æ¡æ‰‹ï¼ˆè¿æ¥å»ºç«‹ï¼‰

### ä¸‰æ¬¡æ¡æ‰‹è¿‡ç¨‹

```
å®¢æˆ·ç«¯                              æœåŠ¡å™¨
  â”‚                                   â”‚
  â”‚â”€â”€â”€â”€â”€â”€ SYN (seq=x) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚  ç¬¬ä¸€æ¬¡æ¡æ‰‹
  â”‚                                   â”‚  æœåŠ¡å™¨æ”¶åˆ°SYNï¼ŒçŸ¥é“å®¢æˆ·ç«¯è¦å»ºç«‹è¿æ¥
  â”‚                                   â”‚
  â”‚â†â”€â”€â”€ SYN-ACK (seq=y, ack=x+1) â”€â”€â”€â”‚  ç¬¬äºŒæ¬¡æ¡æ‰‹
  â”‚                                   â”‚  å®¢æˆ·ç«¯æ”¶åˆ°SYN-ACKï¼ŒçŸ¥é“æœåŠ¡å™¨åŒæ„
  â”‚                                   â”‚
  â”‚â”€â”€â”€â”€â”€â”€ ACK (ack=y+1) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚  ç¬¬ä¸‰æ¬¡æ¡æ‰‹
  â”‚                                   â”‚  æœåŠ¡å™¨æ”¶åˆ°ACKï¼Œè¿æ¥å»ºç«‹
  â”‚                                   â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ è¿æ¥å»ºç«‹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                                   â”‚
```

### ä¸ºä»€ä¹ˆæ˜¯ä¸‰æ¬¡ï¼Ÿ

```
ä¸¤æ¬¡æ¡æ‰‹çš„é—®é¢˜ï¼š
- æ—§çš„é‡å¤SYNåˆ°è¾¾
- æœåŠ¡å™¨å»ºç«‹è¿æ¥
- å®¢æˆ·ç«¯ä¸çŸ¥é“ï¼ˆå·²è¶…æ—¶ï¼‰
- æµªè´¹èµ„æº

ä¸‰æ¬¡æ¡æ‰‹çš„å¥½å¤„ï¼š
- ç¡®è®¤åŒæ–¹çš„å‘é€å’Œæ¥æ”¶èƒ½åŠ›
- é˜²æ­¢æ—§è¿æ¥è¯·æ±‚
- åŒæ­¥åºåˆ—å·
```

### æ¨¡æ‹Ÿä¸‰æ¬¡æ¡æ‰‹

```python
import random

class TCPHandshake:
    def __init__(self):
        self.state = 'CLOSED'
        self.seq = random.randint(1000, 9999)
        self.ack = 0

    def client_connect(self):
        """å®¢æˆ·ç«¯å‘èµ·è¿æ¥"""
        if self.state != 'CLOSED':
            print("é”™è¯¯ï¼šè¿æ¥å·²å­˜åœ¨")
            return None

        # ç¬¬ä¸€æ¬¡æ¡æ‰‹ï¼šå‘é€SYN
        print(f"å®¢æˆ·ç«¯: å‘é€ SYN (seq={self.seq})")
        self.state = 'SYN_SENT'

        return {'type': 'SYN', 'seq': self.seq}

    def server_receive_syn(self, syn_packet):
        """æœåŠ¡å™¨æ¥æ”¶SYN"""
        if self.state != 'CLOSED':
            print("é”™è¯¯ï¼šæœåŠ¡å™¨å¿™")
            return None

        # ç¬¬äºŒæ¬¡æ¡æ‰‹ï¼šå‘é€SYN-ACK
        self.ack = syn_packet['seq'] + 1
        print(f"æœåŠ¡å™¨: æ”¶åˆ° SYN (seq={syn_packet['seq']})")
        print(f"æœåŠ¡å™¨: å‘é€ SYN-ACK (seq={self.seq}, ack={self.ack})")
        self.state = 'SYN_RCVD'

        return {'type': 'SYN-ACK', 'seq': self.seq, 'ack': self.ack}

    def client_receive_syn_ack(self, syn_ack_packet):
        """å®¢æˆ·ç«¯æ¥æ”¶SYN-ACK"""
        if self.state != 'SYN_SENT':
            print("é”™è¯¯ï¼šçŠ¶æ€ä¸æ­£ç¡®")
            return None

        # ç¬¬ä¸‰æ¬¡æ¡æ‰‹ï¼šå‘é€ACK
        self.ack = syn_ack_packet['seq'] + 1
        print(f"å®¢æˆ·ç«¯: æ”¶åˆ° SYN-ACK (seq={syn_ack_packet['seq']}, ack={syn_ack_packet['ack']})")
        print(f"å®¢æˆ·ç«¯: å‘é€ ACK (ack={self.ack})")
        self.state = 'ESTABLISHED'

        return {'type': 'ACK', 'ack': self.ack}

    def server_receive_ack(self, ack_packet):
        """æœåŠ¡å™¨æ¥æ”¶ACK"""
        if self.state != 'SYN_RCVD':
            print("é”™è¯¯ï¼šçŠ¶æ€ä¸æ­£ç¡®")
            return False

        print(f"æœåŠ¡å™¨: æ”¶åˆ° ACK (ack={ack_packet['ack']})")
        print("æœåŠ¡å™¨: è¿æ¥å»ºç«‹ï¼")
        self.state = 'ESTABLISHED'

        return True

# æ¨¡æ‹Ÿä¸‰æ¬¡æ¡æ‰‹
print("=== TCPä¸‰æ¬¡æ¡æ‰‹ ===\n")

client = TCPHandshake()
server = TCPHandshake()

# ç¬¬ä¸€æ¬¡æ¡æ‰‹
syn = client.client_connect()
print()

# ç¬¬äºŒæ¬¡æ¡æ‰‹
syn_ack = server.server_receive_syn(syn)
print()

# ç¬¬ä¸‰æ¬¡æ¡æ‰‹
ack = client.client_receive_syn_ack(syn_ack)
print()

# æœåŠ¡å™¨ç¡®è®¤
server.server_receive_ack(ack)

print(f"\nå®¢æˆ·ç«¯çŠ¶æ€: {client.state}")
print(f"æœåŠ¡å™¨çŠ¶æ€: {server.state}")
```

---

## ğŸ‘‹ å››æ¬¡æŒ¥æ‰‹ï¼ˆè¿æ¥ç»ˆæ­¢ï¼‰

### å››æ¬¡æŒ¥æ‰‹è¿‡ç¨‹

```
å®¢æˆ·ç«¯                              æœåŠ¡å™¨
  â”‚                                   â”‚
  â”‚â”€â”€â”€â”€â”€â”€ FIN (seq=u) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚  ç¬¬ä¸€æ¬¡æŒ¥æ‰‹
  â”‚                                   â”‚  å®¢æˆ·ç«¯ï¼šæˆ‘è¦å…³é—­äº†
  â”‚                                   â”‚
  â”‚â†â”€â”€â”€â”€â”€ ACK (ack=u+1) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚  ç¬¬äºŒæ¬¡æŒ¥æ‰‹
  â”‚                                   â”‚  æœåŠ¡å™¨ï¼šæˆ‘çŸ¥é“äº†ï¼Œç­‰æˆ‘å‘å®Œæ•°æ®
  â”‚                                   â”‚
  â”‚                                   â”‚  æœåŠ¡å™¨ç»§ç»­å‘é€å‰©ä½™æ•°æ®...
  â”‚                                   â”‚
  â”‚â†â”€â”€â”€â”€â”€ FIN (seq=v) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚  ç¬¬ä¸‰æ¬¡æŒ¥æ‰‹
  â”‚                                   â”‚  æœåŠ¡å™¨ï¼šæˆ‘ä¹Ÿè¦å…³é—­äº†
  â”‚                                   â”‚
  â”‚â”€â”€â”€â”€â”€â”€ ACK (ack=v+1) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚  ç¬¬å››æ¬¡æŒ¥æ‰‹
  â”‚                                   â”‚  å®¢æˆ·ç«¯ï¼šå¥½çš„
  â”‚                                   â”‚
  â”œâ”€â”€â”€â”€â”€â”€ TIME_WAIT (2MSL) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                                   â”‚
  â””â”€â”€â”€â”€â”€â”€ CLOSED â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä¸ºä»€ä¹ˆæ˜¯å››æ¬¡ï¼Ÿ

```
ä¸ºä»€ä¹ˆä¸æ˜¯ä¸‰æ¬¡ï¼Ÿ
- TCPæ˜¯å…¨åŒå·¥çš„
- æ¯ä¸ªæ–¹å‘éƒ½éœ€è¦å•ç‹¬å…³é—­
- æœåŠ¡å™¨æ”¶åˆ°FINåï¼š
  1. å…ˆå‘ACKï¼ˆæˆ‘çŸ¥é“ä½ è¦å…³é—­ï¼‰
  2. å‘é€å‰©ä½™æ•°æ®
  3. å†å‘FINï¼ˆæˆ‘ä¹Ÿå…³é—­äº†ï¼‰

TIME_WAITä¸ºä»€ä¹ˆæ˜¯2MSLï¼Ÿ
- MSLï¼ˆMaximum Segment Lifetimeï¼‰ï¼šæŠ¥æ–‡æœ€å¤§ç”Ÿå­˜æ—¶é—´
- 2MSLï¼šç¡®ä¿å¯¹æ–¹æ”¶åˆ°æœ€åçš„ACK
- é˜²æ­¢æ—§è¿æ¥çš„åŒ…å¹²æ‰°æ–°è¿æ¥
```

### æ¨¡æ‹Ÿå››æ¬¡æŒ¥æ‰‹

```python
class TCPClose:
    def __init__(self):
        self.state = 'ESTABLISHED'

    def client_close(self):
        """å®¢æˆ·ç«¯å‘èµ·å…³é—­"""
        if self.state != 'ESTABLISHED':
            print("é”™è¯¯ï¼šè¿æ¥æœªå»ºç«‹")
            return None

        # ç¬¬ä¸€æ¬¡æŒ¥æ‰‹ï¼šå‘é€FIN
        print("å®¢æˆ·ç«¯: å‘é€ FIN")
        self.state = 'FIN_WAIT_1'
        return {'type': 'FIN'}

    def server_receive_fin(self):
        """æœåŠ¡å™¨æ¥æ”¶FIN"""
        if self.state != 'ESTABLISHED':
            print("é”™è¯¯ï¼šçŠ¶æ€ä¸æ­£ç¡®")
            return None

        # ç¬¬äºŒæ¬¡æŒ¥æ‰‹ï¼šå‘é€ACK
        print("æœåŠ¡å™¨: æ”¶åˆ° FIN")
        print("æœåŠ¡å™¨: å‘é€ ACK")
        self.state = 'CLOSE_WAIT'
        return {'type': 'ACK'}

    def client_receive_ack(self):
        """å®¢æˆ·ç«¯æ¥æ”¶ACK"""
        if self.state != 'FIN_WAIT_1':
            print("é”™è¯¯ï¼šçŠ¶æ€ä¸æ­£ç¡®")
            return False

        print("å®¢æˆ·ç«¯: æ”¶åˆ° ACK")
        self.state = 'FIN_WAIT_2'
        return True

    def server_close(self):
        """æœåŠ¡å™¨å…³é—­"""
        if self.state != 'CLOSE_WAIT':
            print("é”™è¯¯ï¼šçŠ¶æ€ä¸æ­£ç¡®")
            return None

        # ç¬¬ä¸‰æ¬¡æŒ¥æ‰‹ï¼šå‘é€FIN
        print("æœåŠ¡å™¨: å‘é€å‰©ä½™æ•°æ®...")
        print("æœåŠ¡å™¨: å‘é€ FIN")
        self.state = 'LAST_ACK'
        return {'type': 'FIN'}

    def client_receive_fin(self):
        """å®¢æˆ·ç«¯æ¥æ”¶FIN"""
        if self.state != 'FIN_WAIT_2':
            print("é”™è¯¯ï¼šçŠ¶æ€ä¸æ­£ç¡®")
            return None

        # ç¬¬å››æ¬¡æŒ¥æ‰‹ï¼šå‘é€ACK
        print("å®¢æˆ·ç«¯: æ”¶åˆ° FIN")
        print("å®¢æˆ·ç«¯: å‘é€ ACK")
        self.state = 'TIME_WAIT'
        return {'type': 'ACK'}

    def server_receive_ack(self):
        """æœåŠ¡å™¨æ¥æ”¶ACK"""
        if self.state != 'LAST_ACK':
            print("é”™è¯¯ï¼šçŠ¶æ€ä¸æ­£ç¡®")
            return False

        print("æœåŠ¡å™¨: æ”¶åˆ° ACK")
        print("æœåŠ¡å™¨: è¿æ¥å…³é—­")
        self.state = 'CLOSED'
        return True

    def time_wait_timeout(self):
        """TIME_WAITè¶…æ—¶"""
        if self.state != 'TIME_WAIT':
            print("é”™è¯¯ï¼šçŠ¶æ€ä¸æ­£ç¡®")
            return False

        print("å®¢æˆ·ç«¯: TIME_WAIT è¶…æ—¶ï¼ˆ2MSLï¼‰")
        print("å®¢æˆ·ç«¯: è¿æ¥å…³é—­")
        self.state = 'CLOSED'
        return True

# æ¨¡æ‹Ÿå››æ¬¡æŒ¥æ‰‹
print("=== TCPå››æ¬¡æŒ¥æ‰‹ ===\n")

client = TCPClose()
server = TCPClose()

# ç¬¬ä¸€æ¬¡æŒ¥æ‰‹
fin1 = client.client_close()
print()

# ç¬¬äºŒæ¬¡æŒ¥æ‰‹
ack1 = server.server_receive_fin()
client.client_receive_ack()
print()

# ç¬¬ä¸‰æ¬¡æŒ¥æ‰‹
fin2 = server.server_close()
print()

# ç¬¬å››æ¬¡æŒ¥æ‰‹
ack2 = client.client_receive_fin()
server.server_receive_ack()
print()

# TIME_WAIT
client.time_wait_timeout()

print(f"\nå®¢æˆ·ç«¯çŠ¶æ€: {client.state}")
print(f"æœåŠ¡å™¨çŠ¶æ€: {server.state}")
```

---

## ğŸ”„ å¯é ä¼ è¾“æœºåˆ¶

### 1. åºåˆ—å·å’Œç¡®è®¤å·

```
å‘é€æ–¹                              æ¥æ”¶æ–¹
  â”‚                                   â”‚
  â”‚â”€â”€â”€ Seq=1000, Data="Hello" â”€â”€â”€â”€â”€â”€â†’â”‚
  â”‚                                   â”‚
  â”‚â†â”€â”€â”€â”€ Ack=1005 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ ç¡®è®¤æ”¶åˆ°ï¼ŒæœŸæœ›ä¸‹ä¸€ä¸ªæ˜¯1005
  â”‚                                   â”‚
  â”‚â”€â”€â”€ Seq=1005, Data="World" â”€â”€â”€â”€â”€â”€â†’â”‚
  â”‚                                   â”‚
  â”‚â†â”€â”€â”€â”€ Ack=1010 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚                                   â”‚
```

### 2. è¶…æ—¶é‡ä¼ 

```python
import time
import random

class ReliableTransfer:
    def __init__(self, timeout=1.0):
        self.timeout = timeout
        self.seq = 0

    def send_with_retransmission(self, data, max_retries=3):
        """å¸¦é‡ä¼ çš„å‘é€"""
        retries = 0

        while retries < max_retries:
            print(f"å°è¯• {retries + 1}: å‘é€æ•°æ® (seq={self.seq})")

            # æ¨¡æ‹Ÿå‘é€
            ack = self.simulate_send(data)

            if ack:
                print(f"æ”¶åˆ°ACK (ack={self.seq + len(data)})")
                self.seq += len(data)
                return True
            else:
                print(f"è¶…æ—¶ï¼ç­‰å¾… {self.timeout} ç§’åé‡ä¼ ...")
                time.sleep(self.timeout)
                retries += 1

        print("è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œå‘é€å¤±è´¥")
        return False

    def simulate_send(self, data):
        """æ¨¡æ‹Ÿå‘é€ï¼ˆå¯èƒ½ä¸¢åŒ…ï¼‰"""
        # 30%æ¦‚ç‡ä¸¢åŒ…
        if random.random() < 0.3:
            print("  [æ¨¡æ‹Ÿ] æ•°æ®åŒ…ä¸¢å¤±")
            return False
        else:
            print("  [æ¨¡æ‹Ÿ] æ•°æ®åŒ…æˆåŠŸé€è¾¾")
            return True

# ä½¿ç”¨
transfer = ReliableTransfer(timeout=0.5)
transfer.send_with_retransmission("Hello", max_retries=5)
```

### 3. æ»‘åŠ¨çª—å£

```python
class SlidingWindow:
    def __init__(self, window_size=4):
        self.window_size = window_size
        self.base = 0  # çª—å£åŸºåºå·
        self.next_seq = 0  # ä¸‹ä¸€ä¸ªè¦å‘é€çš„åºå·
        self.buffer = {}  # {seq: data}

    def can_send(self):
        """æ˜¯å¦å¯ä»¥å‘é€"""
        return self.next_seq < self.base + self.window_size

    def send(self, data):
        """å‘é€æ•°æ®"""
        if not self.can_send():
            print(f"çª—å£å·²æ»¡ï¼Œç­‰å¾…ç¡®è®¤...")
            return False

        seq = self.next_seq
        self.buffer[seq] = data
        print(f"å‘é€: seq={seq}, data={data}")
        self.next_seq += 1
        return True

    def receive_ack(self, ack):
        """æ¥æ”¶ç¡®è®¤"""
        print(f"æ”¶åˆ°ACK: {ack}")

        if ack > self.base:
            # æ»‘åŠ¨çª—å£
            print(f"çª—å£æ»‘åŠ¨: {self.base} â†’ {ack}")
            for seq in range(self.base, ack):
                if seq in self.buffer:
                    del self.buffer[seq]
            self.base = ack

    def show_window(self):
        """æ˜¾ç¤ºçª—å£"""
        print(f"\nå½“å‰çª—å£: [{self.base}, {self.base + self.window_size})")
        print(f"å·²å‘é€æœªç¡®è®¤: {list(self.buffer.keys())}")
        print(f"ä¸‹ä¸€ä¸ªå‘é€: {self.next_seq}\n")

# ä½¿ç”¨
window = SlidingWindow(window_size=4)

# å‘é€å¤šä¸ªæ•°æ®åŒ…
for i in range(6):
    window.send(f"Data{i}")
    window.show_window()

# æ¥æ”¶ç¡®è®¤
window.receive_ack(2)
window.show_window()

# ç»§ç»­å‘é€
window.send("Data6")
window.send("Data7")
window.show_window()

# æ¥æ”¶æ›´å¤šç¡®è®¤
window.receive_ack(5)
window.show_window()
```

---

## ğŸ”— ç›¸å…³æ¦‚å¿µ

- [ç½‘ç»œå±‚](network-layer.md) - IPåè®®
- [åº”ç”¨å±‚](application-layer.md) - HTTPç­‰åº”ç”¨åè®®

---

**è®°ä½**ï¼š
1. ä¼ è¾“å±‚æä¾›ç«¯åˆ°ç«¯é€šä¿¡
2. ç«¯å£å·æ ‡è¯†åº”ç”¨è¿›ç¨‹
3. UDPï¼šå¿«é€Ÿã€ä¸å¯é ã€æ— è¿æ¥
4. TCPï¼šå¯é ã€æœ‰åºã€é¢å‘è¿æ¥
5. ä¸‰æ¬¡æ¡æ‰‹å»ºç«‹è¿æ¥
6. å››æ¬¡æŒ¥æ‰‹ç»ˆæ­¢è¿æ¥
7. TCPé€šè¿‡åºåˆ—å·ã€ç¡®è®¤ã€é‡ä¼ ä¿è¯å¯é æ€§
8. æ»‘åŠ¨çª—å£å®ç°æµé‡æ§åˆ¶
