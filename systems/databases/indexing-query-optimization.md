# ç´¢å¼•ä¸æŸ¥è¯¢ä¼˜åŒ– (Indexing and Query Optimization)

> å¦‚ä½•è®©æ•°æ®åº“æŸ¥è¯¢è·‘å¾—é£å¿«

## ğŸ¯ æ ¸å¿ƒæ¦‚å¿µ

**ç´¢å¼• = æ•°æ®åº“çš„"ç›®å½•"ï¼Œå¸®åŠ©å¿«é€Ÿå®šä½æ•°æ®**

### å…³é”®é—®é¢˜
- æ²¡æœ‰ç´¢å¼•ä¼šæ€æ ·ï¼Ÿ
- ç´¢å¼•æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿ
- å¦‚ä½•é€‰æ‹©åˆé€‚çš„ç´¢å¼•ï¼Ÿ
- å¦‚ä½•ä¼˜åŒ–æ…¢æŸ¥è¯¢ï¼Ÿ

---

## 1ï¸âƒ£ ä¸ºä»€ä¹ˆéœ€è¦ç´¢å¼•ï¼Ÿ

### æ²¡æœ‰ç´¢å¼•çš„æŸ¥è¯¢

```sql
-- è¡¨ï¼šusers (1,000,000 è¡Œ)
SELECT * FROM users WHERE id = 12345;

æ²¡æœ‰ç´¢å¼•ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å…¨è¡¨æ‰«æ (Full Table Scan)             â”‚
â”‚                                         â”‚
â”‚  ä»ç¬¬ä¸€è¡Œå¼€å§‹ï¼Œé€è¡Œæ£€æŸ¥ï¼š               â”‚
â”‚    Row 1: id = 1      âŒ               â”‚
â”‚    Row 2: id = 2      âŒ               â”‚
â”‚    ...                                  â”‚
â”‚    Row 12345: id = 12345  âœ… æ‰¾åˆ°ï¼    â”‚
â”‚    ...                                  â”‚
â”‚    Row 1000000: id = 1000000  (è¿˜è¦ç»§ç»­)â”‚
â”‚                                         â”‚
â”‚  å¹³å‡éœ€è¦æ‰«æ: 500,000 è¡Œ               â”‚
â”‚  æ—¶é—´å¤æ‚åº¦: O(n)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æœ‰ç´¢å¼•ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç´¢å¼•æŸ¥æ‰¾ (Index Seek)                  â”‚
â”‚                                         â”‚
â”‚  é€šè¿‡ B+ æ ‘ç´¢å¼•ï¼š                        â”‚
â”‚    1. æŸ¥æ‰¾æ ¹èŠ‚ç‚¹                        â”‚
â”‚    2. äºŒåˆ†æŸ¥æ‰¾åˆ°å¶å­èŠ‚ç‚¹                â”‚
â”‚    3. ç›´æ¥å®šä½åˆ° id = 12345             â”‚
â”‚                                         â”‚
â”‚  éœ€è¦è®¿é—®: ~3-4 ä¸ªèŠ‚ç‚¹                  â”‚
â”‚  æ—¶é—´å¤æ‚åº¦: O(log n)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ€§èƒ½å¯¹æ¯”ï¼ˆ100ä¸‡è¡Œï¼‰ï¼š
  å…¨è¡¨æ‰«æ: ~1000 ms
  ç´¢å¼•æŸ¥æ‰¾: ~1 ms
  æå‡: 1000 å€ï¼
```

---

## 2ï¸âƒ£ B+ æ ‘ç´¢å¼•

### ä¸ºä»€ä¹ˆç”¨ B+ æ ‘ï¼Ÿ

```
æ•°æ®åº“ç´¢å¼•çš„ç‰¹ç‚¹ï¼š
  â€¢ æ•°æ®é‡å¤§ï¼ˆç™¾ä¸‡ã€åƒä¸‡è¡Œï¼‰
  â€¢ æ•°æ®å­˜å‚¨åœ¨ç£ç›˜
  â€¢ ç£ç›˜ I/O å¾ˆæ…¢ï¼ˆ5-10ms ä¸€æ¬¡ï¼‰
  â€¢ éœ€è¦å‡å°‘ç£ç›˜è®¿é—®æ¬¡æ•°

B+ æ ‘çš„ä¼˜åŠ¿ï¼š
  âœ… æ ‘çš„é«˜åº¦ä½ï¼ˆ3-4 å±‚ï¼‰
  âœ… æ¯æ¬¡ç£ç›˜ I/O è¯»å–å¤šä¸ªé”®
  âœ… å¶å­èŠ‚ç‚¹é“¾æ¥ï¼Œæ”¯æŒèŒƒå›´æŸ¥è¯¢
  âœ… æ‰€æœ‰æ•°æ®éƒ½åœ¨å¶å­èŠ‚ç‚¹ï¼Œå†…éƒ¨èŠ‚ç‚¹åªå­˜é”®
```

### B+ æ ‘ç»“æ„

```
ç¤ºä¾‹ï¼šç´¢å¼• users.id

                     [50, 100]              â† æ ¹èŠ‚ç‚¹ï¼ˆå†…éƒ¨èŠ‚ç‚¹ï¼‰
                    /    |    \
                   /     |     \
          [10,25,40]  [60,75,90]  [110,125]  â† å†…éƒ¨èŠ‚ç‚¹
           /   |   \    /  |  \     /   |
          /    |    \  /   |   \   /    |
    [1-10] [11-25] [26-40] ...       [126-150] â† å¶å­èŠ‚ç‚¹
      â†“      â†“       â†“                   â†“
    æ•°æ®    æ•°æ®     æ•°æ®                æ•°æ®
      â†”      â†”       â†”                   â†”
    (å¶å­èŠ‚ç‚¹ä¹‹é—´æœ‰åŒå‘é“¾è¡¨)

ç‰¹ç‚¹ï¼š
  â€¢ å†…éƒ¨èŠ‚ç‚¹ï¼šåªå­˜é”®ï¼ˆç”¨äºå¯¼èˆªï¼‰
  â€¢ å¶å­èŠ‚ç‚¹ï¼šå­˜é”®+æ•°æ®æŒ‡é’ˆ
  â€¢ å¶å­èŠ‚ç‚¹é“¾æ¥ï¼šæ”¯æŒèŒƒå›´æ‰«æ
  â€¢ æ¯ä¸ªèŠ‚ç‚¹å¤§å° = ç£ç›˜é¡µå¤§å°ï¼ˆ4KB/16KBï¼‰
```

### æŸ¥è¯¢è¿‡ç¨‹

```sql
SELECT * FROM users WHERE id = 75;

æ­¥éª¤ï¼š
1. è¯»å–æ ¹èŠ‚ç‚¹ [50, 100]
   â†’ 75 åœ¨ 50 å’Œ 100 ä¹‹é—´
   â†’ è·³è½¬åˆ°ä¸­é—´å­èŠ‚ç‚¹

2. è¯»å–å†…éƒ¨èŠ‚ç‚¹ [60, 75, 90]
   â†’ 75 ç­‰äºç¬¬äºŒä¸ªé”®
   â†’ è·³è½¬åˆ°å¯¹åº”å¶å­èŠ‚ç‚¹

3. è¯»å–å¶å­èŠ‚ç‚¹ï¼Œæ‰¾åˆ° id=75 çš„æ•°æ®æŒ‡é’ˆ
   â†’ æ ¹æ®æŒ‡é’ˆè¯»å–å®é™…æ•°æ®

æ€»å…±ç£ç›˜ I/Oï¼š3-4 æ¬¡
æ—¶é—´ï¼š~15-20msï¼ˆå‡è®¾æ¯æ¬¡ I/O 5msï¼‰
```

### èŒƒå›´æŸ¥è¯¢

```sql
SELECT * FROM users WHERE id BETWEEN 60 AND 90;

æ­¥éª¤ï¼š
1. é€šè¿‡ B+ æ ‘æ‰¾åˆ°èµ·å§‹ä½ç½®ï¼ˆid=60 çš„å¶å­èŠ‚ç‚¹ï¼‰
2. é¡ºç€å¶å­èŠ‚ç‚¹é“¾è¡¨æ‰«æåˆ° id=90
   â†’ å¶å­èŠ‚ç‚¹æ˜¯æœ‰åºçš„ï¼
   â†’ ä¸éœ€è¦å†æ¬¡æœç´¢

è¿™å°±æ˜¯ B+ æ ‘çš„ä¼˜åŠ¿ï¼šèŒƒå›´æŸ¥è¯¢é«˜æ•ˆï¼
```

---

## 3ï¸âƒ£ ç´¢å¼•ç±»å‹

### 1. èšç°‡ç´¢å¼• (Clustered Index)

```
æ•°æ®æŒ‰ç´¢å¼•é¡ºåºç‰©ç†å­˜å‚¨

InnoDB çš„ä¸»é”®å°±æ˜¯èšç°‡ç´¢å¼•ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  B+ æ ‘å¶å­èŠ‚ç‚¹ç›´æ¥å­˜å‚¨å®Œæ•´è¡Œæ•°æ®    â”‚
â”‚                                     â”‚
â”‚    [é”®: id=1, æ•°æ®: {id:1, name:Alice, age:20}]
â”‚    [é”®: id=2, æ•°æ®: {id:2, name:Bob, age:22}]
â”‚    [é”®: id=3, æ•°æ®: {id:3, name:Carol, age:21}]
â”‚                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç‰¹ç‚¹ï¼š
  â€¢ ä¸€ä¸ªè¡¨åªèƒ½æœ‰ä¸€ä¸ªèšç°‡ç´¢å¼•ï¼ˆä¸»é”®ï¼‰
  â€¢ æ•°æ®ç‰©ç†æœ‰åº
  â€¢ æŸ¥è¯¢ä¸»é”®æœ€å¿«ï¼ˆä¸éœ€è¦å›è¡¨ï¼‰
  â€¢ æ’å…¥å¯èƒ½å¯¼è‡´é¡µåˆ†è£‚ï¼ˆå½±å“æ€§èƒ½ï¼‰
```

### 2. éèšç°‡ç´¢å¼• (Secondary Index)

```
ç´¢å¼•å’Œæ•°æ®åˆ†ç¦»å­˜å‚¨

CREATE INDEX idx_name ON users(name);

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  B+ æ ‘å¶å­èŠ‚ç‚¹å­˜å‚¨ï¼šé”® + ä¸»é”®å€¼     â”‚
â”‚                                     â”‚
â”‚    [é”®: "Alice", ä¸»é”®: 1]          â”‚
â”‚    [é”®: "Bob",   ä¸»é”®: 2]          â”‚
â”‚    [é”®: "Carol", ä¸»é”®: 3]          â”‚
â”‚                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æŸ¥è¯¢è¿‡ç¨‹ï¼š
  SELECT * FROM users WHERE name = 'Bob';

  1. åœ¨ idx_name ç´¢å¼•ä¸­æ‰¾åˆ° "Bob" â†’ å¾—åˆ°ä¸»é”® 2
  2. ç”¨ä¸»é”® 2 å»èšç°‡ç´¢å¼•æŸ¥æ‰¾å®Œæ•´æ•°æ®
     â†’ è¿™å«"å›è¡¨" (Table Lookup)

  ä¸¤æ¬¡ç´¢å¼•æŸ¥è¯¢ï¼
```

### 3. è¦†ç›–ç´¢å¼• (Covering Index)

```
ç´¢å¼•åŒ…å«æŸ¥è¯¢æ‰€éœ€çš„æ‰€æœ‰åˆ—

CREATE INDEX idx_name_age ON users(name, age);

SELECT name, age FROM users WHERE name = 'Bob';
                   â†‘
        åªéœ€è¦ name å’Œ ageï¼Œç´¢å¼•å·²ç»åŒ…å«ï¼
        â†’ ä¸éœ€è¦å›è¡¨ï¼Œç›´æ¥ä»ç´¢å¼•è¿”å›

æ€§èƒ½æå‡ï¼šé¿å…äº†å›è¡¨çš„å¼€é”€
```

### 4. è”åˆç´¢å¼• (Composite Index)

```
å¤šåˆ—ç»„æˆçš„ç´¢å¼•

CREATE INDEX idx_name_age ON users(name, age);

ç´¢å¼•ç»“æ„ï¼ˆæŒ‰ name, age æ’åºï¼‰ï¼š
  [Alice, 20] â†’ ä¸»é”® 1
  [Alice, 25] â†’ ä¸»é”® 4
  [Bob, 22]   â†’ ä¸»é”® 2
  [Carol, 21] â†’ ä¸»é”® 3

æœ€å·¦å‰ç¼€åŸåˆ™ï¼š
  âœ… WHERE name = 'Bob'                (ç”¨åˆ°ç´¢å¼•)
  âœ… WHERE name = 'Bob' AND age = 22   (ç”¨åˆ°ç´¢å¼•)
  âŒ WHERE age = 22                    (ç”¨ä¸åˆ°ç´¢å¼•)

  åŸå› ï¼šç´¢å¼•å…ˆæŒ‰ name æ’åºï¼Œå†æŒ‰ age æ’åº
        ç›´æ¥æŸ¥ age æ— æ³•åˆ©ç”¨ç´¢å¼•çš„æœ‰åºæ€§
```

---

## 4ï¸âƒ£ å“ˆå¸Œç´¢å¼•

### åŸç†

```
ä½¿ç”¨å“ˆå¸Œè¡¨å­˜å‚¨ç´¢å¼•

CREATE INDEX idx_hash ON users(id) USING HASH;

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Hash(id) â†’ æ•°æ®æŒ‡é’ˆ             â”‚
â”‚                                  â”‚
â”‚  Hash(1) = 123   â†’ æŒ‡é’ˆA        â”‚
â”‚  Hash(2) = 456   â†’ æŒ‡é’ˆB        â”‚
â”‚  Hash(3) = 789   â†’ æŒ‡é’ˆC        â”‚
â”‚                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ä¼˜ç‚¹ï¼š
  â€¢ ç­‰å€¼æŸ¥è¯¢æå¿« O(1)
  â€¢ SELECT * FROM users WHERE id = 5;

ç¼ºç‚¹ï¼š
  âŒ ä¸æ”¯æŒèŒƒå›´æŸ¥è¯¢
  âŒ ä¸æ”¯æŒæ’åº
  âŒ ä¸æ”¯æŒæœ€å·¦å‰ç¼€
  âŒ å“ˆå¸Œå†²çªå¤„ç†å¼€é”€
```

### é€‚ç”¨åœºæ™¯

```
ä½¿ç”¨å“ˆå¸Œç´¢å¼•ï¼š
  â€¢ åªæœ‰ç­‰å€¼æŸ¥è¯¢
  â€¢ å†…å­˜æ•°æ®åº“ï¼ˆRedisï¼‰

ä½¿ç”¨ B+ æ ‘ç´¢å¼•ï¼š
  â€¢ èŒƒå›´æŸ¥è¯¢
  â€¢ æ’åº
  â€¢ å¤§å¤šæ•°å…³ç³»å‹æ•°æ®åº“
```

---

## 5ï¸âƒ£ ç´¢å¼•è®¾è®¡åŸåˆ™

### 1. é€‰æ‹©æ€§é«˜çš„åˆ—

```
é€‰æ‹©æ€§ = ä¸åŒå€¼æ•°é‡ / æ€»è¡Œæ•°

ä¾‹å­ï¼šusers è¡¨ï¼ˆ100ä¸‡è¡Œï¼‰
  â€¢ id åˆ—ï¼š1,000,000 ç§ä¸åŒå€¼ â†’ é€‰æ‹©æ€§ = 1.0  âœ…
  â€¢ age åˆ—ï¼š100 ç§ä¸åŒå€¼       â†’ é€‰æ‹©æ€§ = 0.0001  âš ï¸
  â€¢ gender: 2 ç§ä¸åŒå€¼         â†’ é€‰æ‹©æ€§ = 0.000002  âŒ

é€‰æ‹©æ€§è¶Šé«˜ï¼Œç´¢å¼•è¶Šæœ‰æ•ˆï¼

gender åˆ—å»ºç´¢å¼•å‡ ä¹æ²¡ç”¨ï¼š
  SELECT * FROM users WHERE gender = 'M';
  â†’ ä¼šè¿”å›çº¦ 50% çš„æ•°æ®
  â†’ è¿˜ä¸å¦‚å…¨è¡¨æ‰«æ
```

### 2. é¢‘ç¹æŸ¥è¯¢çš„åˆ—

```
åœ¨ WHEREã€JOINã€ORDER BYã€GROUP BY ä¸­å¸¸ç”¨çš„åˆ—å»ºç´¢å¼•

âœ… WHERE id = 123          â†’ id å»ºç´¢å¼•
âœ… WHERE age > 20          â†’ age å»ºç´¢å¼•
âœ… ORDER BY create_time    â†’ create_time å»ºç´¢å¼•
âœ… JOIN ON user_id         â†’ user_id å»ºç´¢å¼•
```

### 3. é¿å…è¿‡å¤šç´¢å¼•

```
ç´¢å¼•çš„ä»£ä»·ï¼š
  â€¢ å ç”¨ç£ç›˜ç©ºé—´
  â€¢ æ’å…¥/æ›´æ–°/åˆ é™¤æ—¶éœ€è¦ç»´æŠ¤ç´¢å¼•
  â€¢ æŸ¥è¯¢ä¼˜åŒ–å™¨é€‰æ‹©ç´¢å¼•çš„æ—¶é—´å¢åŠ 

ä¾‹å­ï¼š
  users è¡¨æœ‰ 10 ä¸ªç´¢å¼•
  INSERT ä¸€è¡Œæ•°æ® â†’éœ€è¦æ›´æ–° 10 ä¸ªç´¢å¼•
  â†’ æ’å…¥å˜æ…¢ 10 å€ï¼

å»ºè®®ï¼š
  â€¢ åªä¸ºå¸¸ç”¨æŸ¥è¯¢å»ºç´¢å¼•
  â€¢ å®šæœŸæ£€æŸ¥æœªä½¿ç”¨çš„ç´¢å¼•å¹¶åˆ é™¤
```

### 4. è”åˆç´¢å¼•é¡ºåº

```
æ ¹æ®æŸ¥è¯¢æ¨¡å¼è®¾è®¡é¡ºåº

åœºæ™¯1ï¼šæŸ¥è¯¢æ¡ä»¶å›ºå®š
  WHERE name = ? AND age = ?
  â†’ CREATE INDEX idx ON users(name, age);

åœºæ™¯2ï¼šç‹¬ç«‹æŸ¥è¯¢ä¹Ÿå¾ˆå¤š
  WHERE name = ?    (é¢‘ç¹)
  WHERE age = ?     (é¢‘ç¹)
  WHERE name = ? AND age = ?  (é¢‘ç¹)

  â†’ å»ºä¸¤ä¸ªç´¢å¼•:
    INDEX idx_name ON users(name)
    INDEX idx_age ON users(age)

åœºæ™¯3ï¼šé€‰æ‹©æ€§è€ƒè™‘
  WHERE country = ? AND city = ?
  å›½å®¶é€‰æ‹©æ€§ä½ï¼ˆ200ä¸ªï¼‰ï¼ŒåŸå¸‚é€‰æ‹©æ€§é«˜ï¼ˆ10000ä¸ªï¼‰

  âœ… INDEX(country, city) â†’ åˆç†
     å…ˆè¿‡æ»¤å›½å®¶ï¼Œå†ç²¾ç¡®å®šä½åŸå¸‚

  âŒ INDEX(city, country) â†’ æµªè´¹
     city å·²ç»å¾ˆç²¾ç¡®ï¼Œcountry å¸®åŠ©ä¸å¤§
```

---

## 6ï¸âƒ£ æŸ¥è¯¢ä¼˜åŒ–

### ä½¿ç”¨ EXPLAIN åˆ†ææŸ¥è¯¢

```sql
EXPLAIN SELECT * FROM users WHERE age > 20;

ç»“æœï¼š
â”Œâ”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”
â”‚ id â”‚ select_type â”‚table â”‚ type â”‚  key    â”‚ rows â”‚ Extra â”‚ ... â”‚
â”œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¤
â”‚ 1  â”‚  SIMPLE     â”‚users â”‚ ALL  â”‚  NULL   â”‚100000â”‚ Using â”‚ ... â”‚
â”‚    â”‚             â”‚      â”‚      â”‚         â”‚      â”‚ where â”‚     â”‚
â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”˜

å…³é”®å­—æ®µï¼š
  â€¢ type: è®¿é—®ç±»å‹
    - ALL: å…¨è¡¨æ‰«æ âŒ æœ€å·®
    - index: ç´¢å¼•æ‰«æ
    - range: èŒƒå›´æ‰«æ âœ… è¾ƒå¥½
    - ref: ç´¢å¼•æŸ¥æ‰¾ âœ… å¥½
    - eq_ref: å”¯ä¸€ç´¢å¼•æŸ¥æ‰¾
    - const: å¸¸é‡æŸ¥æ‰¾ âœ… æœ€å¥½

  â€¢ key: ä½¿ç”¨çš„ç´¢å¼•
    - NULL: æ²¡æœ‰ä½¿ç”¨ç´¢å¼• âŒ

  â€¢ rows: æ‰«æçš„è¡Œæ•°
    - è¶Šå°‘è¶Šå¥½

  â€¢ Extra:
    - Using index: è¦†ç›–ç´¢å¼• âœ…
    - Using where: æœåŠ¡å™¨å±‚è¿‡æ»¤
    - Using filesort: æ–‡ä»¶æ’åº âŒ æ…¢
    - Using temporary: ä¸´æ—¶è¡¨ âŒ æ…¢
```

### å¸¸è§ä¼˜åŒ–æŠ€å·§

#### 1. é¿å… SELECT *

```sql
-- âŒ ä¸å¥½
SELECT * FROM users WHERE id = 1;

-- âœ… æ›´å¥½
SELECT id, name, email FROM users WHERE id = 1;

åŸå› ï¼š
  â€¢ å‡å°‘ç½‘ç»œä¼ è¾“
  â€¢ å¯èƒ½åˆ©ç”¨è¦†ç›–ç´¢å¼•
  â€¢ å‡å°‘ I/O
```

#### 2. ä½¿ç”¨ LIMIT

```sql
-- âŒ è¿”å›æ‰€æœ‰ç»“æœ
SELECT * FROM users WHERE age > 20;

-- âœ… é™åˆ¶ç»“æœé›†
SELECT * FROM users WHERE age > 20 LIMIT 100;

åŸå› ï¼š
  â€¢ å‡å°‘æ•°æ®ä¼ è¾“
  â€¢ æå‰ç»ˆæ­¢æŸ¥è¯¢
```

#### 3. é¿å…åœ¨ç´¢å¼•åˆ—ä¸Šä½¿ç”¨å‡½æ•°

```sql
-- âŒ ä¸ä¼šä½¿ç”¨ç´¢å¼•
SELECT * FROM users WHERE YEAR(birthday) = 2000;

-- âœ… ä¼šä½¿ç”¨ç´¢å¼•
SELECT * FROM users
WHERE birthday BETWEEN '2000-01-01' AND '2000-12-31';

åŸå› ï¼š
  å‡½æ•°ç ´åäº†ç´¢å¼•çš„æœ‰åºæ€§
```

#### 4. é¿å…éšå¼ç±»å‹è½¬æ¢

```sql
-- id æ˜¯ INT ç±»å‹

-- âŒ å­—ç¬¦ä¸²æ¯”è¾ƒï¼Œä¸ä¼šä½¿ç”¨ç´¢å¼•
SELECT * FROM users WHERE id = '123';

-- âœ… æ•°å­—æ¯”è¾ƒï¼Œä¼šä½¿ç”¨ç´¢å¼•
SELECT * FROM users WHERE id = 123;
```

#### 5. ä½¿ç”¨ IN ä»£æ›¿ OR

```sql
-- âŒ OR å¯èƒ½ä¸èµ°ç´¢å¼•
SELECT * FROM users WHERE id = 1 OR id = 2 OR id = 3;

-- âœ… IN ä¼šä¼˜åŒ–
SELECT * FROM users WHERE id IN (1, 2, 3);
```

#### 6. é¿å…å‰å¯¼æ¨¡ç³ŠæŸ¥è¯¢

```sql
-- âŒ å‰å¯¼é€šé…ç¬¦ä¸èµ°ç´¢å¼•
SELECT * FROM users WHERE name LIKE '%Alice';

-- âœ… åç¼€é€šé…ç¬¦èµ°ç´¢å¼•
SELECT * FROM users WHERE name LIKE 'Alice%';

åŸå› ï¼š
  B+ æ ‘æ˜¯æŒ‰é”®å€¼æœ‰åºçš„
  '%Alice' æ— æ³•ç¡®å®šä»å“ªé‡Œå¼€å§‹æŸ¥æ‰¾
```

---

## 7ï¸âƒ£ æŸ¥è¯¢æ‰§è¡Œè®¡åˆ’

### æŸ¥è¯¢ä¼˜åŒ–å™¨çš„å·¥ä½œ

```
SQL æŸ¥è¯¢ â†’ æŸ¥è¯¢ä¼˜åŒ–å™¨ â†’ æ‰§è¡Œè®¡åˆ’

ä¼˜åŒ–å™¨è€ƒè™‘ï¼š
  1. å¯ç”¨çš„ç´¢å¼•
  2. ç»Ÿè®¡ä¿¡æ¯ï¼ˆè¡¨å¤§å°ã€ç´¢å¼•é€‰æ‹©æ€§ï¼‰
  3. ä¸åŒæ‰§è¡Œæ–¹æ¡ˆçš„ä»£ä»·
  4. é€‰æ‹©ä»£ä»·æœ€å°çš„æ–¹æ¡ˆ
```

### è¿æ¥ç®—æ³•

```
SELECT * FROM users u JOIN orders o ON u.id = o.user_id;

1. Nested Loop Joinï¼ˆåµŒå¥—å¾ªç¯ï¼‰
   for each row in users:
       for each row in orders:
           if match: return

   æ—¶é—´å¤æ‚åº¦ï¼šO(n Ã— m)
   é€‚ç”¨ï¼šå°è¡¨

2. Hash Joinï¼ˆå“ˆå¸Œè¿æ¥ï¼‰
   â€¢ æ‰«æ usersï¼Œæ„å»ºå“ˆå¸Œè¡¨
   â€¢ æ‰«æ ordersï¼Œæ¢æµ‹å“ˆå¸Œè¡¨

   æ—¶é—´å¤æ‚åº¦ï¼šO(n + m)
   é€‚ç”¨ï¼šå¤§è¡¨ç­‰å€¼è¿æ¥

3. Merge Joinï¼ˆå½’å¹¶è¿æ¥ï¼‰
   â€¢ ä¸¤è¡¨éƒ½æŒ‰è¿æ¥é”®æ’åº
   â€¢ åŒæ—¶æ‰«æï¼Œåˆå¹¶ç»“æœ

   æ—¶é—´å¤æ‚åº¦ï¼šO(n log n + m log m)
   é€‚ç”¨ï¼šå·²æ’åºæˆ–æœ‰ç´¢å¼•
```

---

## 8ï¸âƒ£ å®é™…æ¡ˆä¾‹

### æ¡ˆä¾‹ 1ï¼šæ…¢æŸ¥è¯¢ä¼˜åŒ–

```sql
-- åŸæŸ¥è¯¢ï¼š3 ç§’
SELECT * FROM orders
WHERE user_id = 123
  AND status = 'completed'
  AND create_time > '2024-01-01';

-- åˆ†æ
EXPLAINï¼štype=ALL, rows=1000000

-- é—®é¢˜ï¼šå…¨è¡¨æ‰«æï¼Œæ²¡æœ‰ç´¢å¼•

-- è§£å†³ï¼šåˆ›å»ºè”åˆç´¢å¼•
CREATE INDEX idx_user_status_time
ON orders(user_id, status, create_time);

-- ä¼˜åŒ–åï¼š0.01 ç§’
-- EXPLAINï¼štype=range, key=idx_user_status_time, rows=50
```

### æ¡ˆä¾‹ 2ï¼šåˆ†é¡µä¼˜åŒ–

```sql
-- æ·±åˆ†é¡µå¾ˆæ…¢ï¼š10 ç§’
SELECT * FROM posts
ORDER BY id DESC
LIMIT 1000000, 20;

-- é—®é¢˜ï¼šéœ€è¦æ‰«æå‰ 1000000 è¡Œ

-- ä¼˜åŒ–ï¼šä½¿ç”¨æ¸¸æ ‡
SELECT * FROM posts
WHERE id < last_seen_id
ORDER BY id DESC
LIMIT 20;

-- æˆ–è€…ï¼šå­æŸ¥è¯¢å…ˆæ‰¾ ID
SELECT * FROM posts
WHERE id IN (
    SELECT id FROM posts
    ORDER BY id DESC
    LIMIT 1000000, 20
);

-- æ—¶é—´ï¼š0.1 ç§’
```

### æ¡ˆä¾‹ 3ï¼šCOUNT ä¼˜åŒ–

```sql
-- æ…¢ï¼š2 ç§’
SELECT COUNT(*) FROM orders WHERE status = 'pending';

-- é—®é¢˜ï¼šå…¨è¡¨æ‰«æ

-- ä¼˜åŒ–1ï¼šæ·»åŠ ç´¢å¼•
CREATE INDEX idx_status ON orders(status);

-- ä¼˜åŒ–2ï¼šä½¿ç”¨è¿‘ä¼¼å€¼ï¼ˆé€‚åˆå¤§è¡¨ï¼‰
SELECT COUNT(*) FROM information_schema.TABLES
WHERE TABLE_NAME = 'orders';

-- ä¼˜åŒ–3ï¼šç»´æŠ¤è®¡æ•°å™¨è¡¨
CREATE TABLE order_stats (
    status VARCHAR(20),
    count INT
);
-- ç”¨è§¦å‘å™¨æˆ–å®šæ—¶ä»»åŠ¡æ›´æ–°
```

---

## ğŸ”— ä¸å…¶ä»–æ¦‚å¿µçš„è”ç³»

### ä¸æ•°æ®ç»“æ„
- **B+ æ ‘** - ç´¢å¼•çš„æ ¸å¿ƒå®ç°
- **å“ˆå¸Œè¡¨** - å“ˆå¸Œç´¢å¼•

å‚è€ƒï¼š`fundamentals/data-structures/`

### ä¸ç®—æ³•
- **æ’åºç®—æ³•** - ORDER BY å®ç°
- **è¿æ¥ç®—æ³•** - JOIN ä¼˜åŒ–

å‚è€ƒï¼š`fundamentals/algorithms/`

### ä¸æ“ä½œç³»ç»Ÿ
- **ç¼“å†²ç®¡ç†** - å‡å°‘ç£ç›˜ I/O
- **é¡µç¼“å­˜** - åŠ é€Ÿè®¿é—®

å‚è€ƒï¼š`systems/operating-systems/`

---

## ğŸ“š æ·±å…¥å­¦ä¹ 

### æ¨èèµ„æº
- *High Performance MySQL* - æŸ¥è¯¢ä¼˜åŒ–ç« èŠ‚
- *Database System Concepts* - ç´¢å¼•ç« èŠ‚
- MySQL/PostgreSQL å®˜æ–¹æ–‡æ¡£

### å®è·µé¡¹ç›®
- åˆ†æçœŸå®åº”ç”¨çš„æ…¢æŸ¥è¯¢
- ä½¿ç”¨ EXPLAIN ä¼˜åŒ–æŸ¥è¯¢
- è®¾è®¡åˆç†çš„ç´¢å¼•ç­–ç•¥

### ä¸‹ä¸€æ­¥
- [äº‹åŠ¡ä¸å¹¶å‘æ§åˆ¶](./transactions-concurrency.md) - ä¿è¯æ•°æ®ä¸€è‡´æ€§
- [å­˜å‚¨å¼•æ“](./storage-engines.md) - ç†è§£ç´¢å¼•å®ç°
- [å…³ç³»æ¨¡å‹](./relational-model-sql.md) - SQL åŸºç¡€

---

**æŒæ¡ç´¢å¼•å’ŒæŸ¥è¯¢ä¼˜åŒ–ï¼Œè®©ä½ çš„æ•°æ®åº“é£èµ·æ¥ï¼** ğŸš€
