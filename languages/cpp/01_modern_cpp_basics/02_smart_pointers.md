# æ™ºèƒ½æŒ‡é’ˆ

> å‘Šåˆ«è£¸æŒ‡é’ˆï¼Œè‡ªåŠ¨å†…å­˜ç®¡ç†

## è£¸æŒ‡é’ˆçš„ä¸‰å¤§é—®é¢˜

1. **æ‰€æœ‰æƒä¸æ¸…æ™°**ï¼š`void foo(int* p)` è°è´Ÿè´£é‡Šæ”¾ï¼Ÿ
2. **å®¹æ˜“å¿˜è®°é‡Šæ”¾**ï¼šå¼‚å¸¸æˆ–æå‰ return å¯¼è‡´å†…å­˜æ³„æ¼
3. **æ‚¬ç©ºæŒ‡é’ˆ**ï¼š`delete p; *p = 20;` è®¿é—®å·²é‡Šæ”¾å†…å­˜

## ä¸‰ç§æ™ºèƒ½æŒ‡é’ˆ

### unique_ptrï¼ˆ90% çš„æƒ…å†µç”¨å®ƒï¼‰

**ç‹¬å æ‰€æœ‰æƒï¼Œä¸èƒ½æ‹·è´ï¼Œåªèƒ½ç§»åŠ¨**

```cpp
// åˆ›å»ºæ–¹å¼1ï¼šmake_uniqueï¼ˆæ¨èï¼Œå¼‚å¸¸å®‰å…¨ï¼‰
auto p1 = std::make_unique<int>(42);

// åˆ›å»ºæ–¹å¼2ï¼šç›´æ¥æ„é€ ï¼ˆä¹Ÿå¯ä»¥ï¼‰
std::unique_ptr<int> p2(new int(42));

// æ³¨æ„ï¼šmake_unique ä¸æ˜¯å¿…é¡»çš„ï¼Œä½†æ›´æ¨è
//      make_unique = æ›´å®‰å…¨ + æ›´ç®€æ´

// ä¸èƒ½æ‹·è´
// auto p2 = p1;  // âŒ ç¼–è¯‘é”™è¯¯

// å¯ä»¥ç§»åŠ¨
auto p2 = std::move(p1);  // p1 å˜ç©ºï¼Œp2 æ‹¥æœ‰èµ„æº

// è®¿é—®
*p2 = 100;
int* raw = p2.get();  // è·å–åŸå§‹æŒ‡é’ˆ

// æ•°ç»„
auto arr = std::make_unique<int[]>(100);
arr[0] = 42;
```

### shared_ptrï¼ˆéœ€è¦å…±äº«æ—¶ç”¨ï¼‰

**å…±äº«æ‰€æœ‰æƒï¼Œå¼•ç”¨è®¡æ•°ï¼Œæœ€åä¸€ä¸ªé”€æ¯æ—¶é‡Šæ”¾**

```cpp
// åˆ›å»ºæ–¹å¼1ï¼šmake_sharedï¼ˆæ¨èï¼Œæ€§èƒ½æ›´å¥½ï¼‰
auto p1 = std::make_shared<int>(42);

// åˆ›å»ºæ–¹å¼2ï¼šç›´æ¥æ„é€ ï¼ˆä¸æ¨èï¼Œä¸¤æ¬¡å†…å­˜åˆ†é…ï¼‰
std::shared_ptr<int> p2(new int(42));

// make_shared çš„ä¼˜åŠ¿ï¼šä¸€æ¬¡å†…å­˜åˆ†é…ï¼ˆå¯¹è±¡+æ§åˆ¶å—ï¼‰
// ç›´æ¥æ„é€ ï¼šä¸¤æ¬¡å†…å­˜åˆ†é…ï¼ˆå¯¹è±¡ + æ§åˆ¶å—åˆ†å¼€ï¼‰

// æ‹·è´ï¼ˆå¼•ç”¨è®¡æ•° +1ï¼‰
auto p2 = p1;  // å¼•ç”¨è®¡æ•° = 2

// æŸ¥è¯¢å¼•ç”¨è®¡æ•°
std::cout << p1.use_count();  // 2

// é‡ç½®ï¼ˆå¼•ç”¨è®¡æ•° -1ï¼‰
p1.reset();  // å¼•ç”¨è®¡æ•° = 1
```

### weak_ptrï¼ˆæ‰“ç ´å¾ªç¯å¼•ç”¨ï¼‰

**ä¸æ‹¥æœ‰å¯¹è±¡ï¼Œä¸å¢åŠ å¼•ç”¨è®¡æ•°**

#### ä¸ºä»€ä¹ˆéœ€è¦ weak_ptrï¼Ÿ

**é—®é¢˜ï¼š`shared_ptr` çš„å¾ªç¯å¼•ç”¨ä¼šå¯¼è‡´å†…å­˜æ³„æ¼**

```cpp
// âŒ é”™è¯¯ç¤ºä¾‹ï¼šå¾ªç¯å¼•ç”¨å¯¼è‡´å†…å­˜æ³„æ¼
struct Node {
    std::shared_ptr<Node> next;  // å¼ºå¼•ç”¨
    std::shared_ptr<Node> prev;  // ä¹Ÿæ˜¯å¼ºå¼•ç”¨ ğŸ’¥
    ~Node() { std::cout << "Node destroyed\n"; }
};

auto n1 = std::make_shared<Node>();
auto n2 = std::make_shared<Node>();
n1->next = n2;  // n2 çš„å¼•ç”¨è®¡æ•° = 2
n2->prev = n1;  // n1 çš„å¼•ç”¨è®¡æ•° = 2

// ç¨‹åºç»“æŸæ—¶ï¼š
// n1 ææ„ â†’ n1 å¯¹è±¡çš„ ref_count ä» 2 å˜ä¸º 1ï¼ˆn2->prev è¿˜åœ¨æŒ‡å‘ï¼‰
// n2 ææ„ â†’ n2 å¯¹è±¡çš„ ref_count ä» 2 å˜ä¸º 1ï¼ˆn1->next è¿˜åœ¨æŒ‡å‘ï¼‰
// ğŸ’¥ ä¸¤ä¸ªå¯¹è±¡éƒ½ä¸ä¼šè¢«åˆ é™¤ï¼å†…å­˜æ³„æ¼ï¼
// ä¸ä¼šè¾“å‡º "Node destroyed"
```

**å†…å­˜å¸ƒå±€ï¼ˆå¾ªç¯å¼•ç”¨ï¼‰ï¼š**
```
n1 å¯¹è±¡ (ref=1) â†â”€â”
  â””â†’ next â”€â”€â”€â”€â”   â”‚
              â†“   â”‚
n2 å¯¹è±¡ (ref=1) â”‚  â”‚
  â””â†’ prev â”€â”€â”€â”€â”€â”´â”€â”€â”˜

å¼•ç”¨è®¡æ•°éƒ½æ˜¯ 1ï¼Œæ°¸è¿œåˆ ä¸æ‰ï¼
```

#### è§£å†³æ–¹æ¡ˆï¼šç”¨ weak_ptr æ‰“ç ´å¾ªç¯

```cpp
// âœ… æ­£ç¡®ç¤ºä¾‹ï¼šä¸€ä¸ªå¼ºå¼•ç”¨ + ä¸€ä¸ªå¼±å¼•ç”¨
struct Node {
    std::shared_ptr<Node> next;  // å¼ºå¼•ç”¨ï¼ˆæ‹¥æœ‰æ‰€æœ‰æƒï¼‰
    std::weak_ptr<Node> prev;    // å¼±å¼•ç”¨ï¼ˆä¸æ‹¥æœ‰æ‰€æœ‰æƒï¼‰âœ…
    ~Node() { std::cout << "Node destroyed\n"; }
};

auto n1 = std::make_shared<Node>();  // n1 å¯¹è±¡ ref=1
auto n2 = std::make_shared<Node>();  // n2 å¯¹è±¡ ref=1

n1->next = n2;  // n2 å¯¹è±¡ ref=2ï¼ˆshared_ptr å¢åŠ è®¡æ•°ï¼‰
n2->prev = n1;  // n1 å¯¹è±¡ ref=1ï¼ˆweak_ptr ä¸å¢åŠ è®¡æ•°ï¼‰âœ…

// ç¨‹åºç»“æŸæ—¶ï¼š
// n2 ææ„ â†’ n2 å¯¹è±¡ ref ä» 2 å˜ä¸º 1
// n1 ææ„ â†’ n1 å¯¹è±¡ ref ä» 1 å˜ä¸º 0 â†’ åˆ é™¤ n1 å¯¹è±¡ âœ…
//         â†’ n1->next ææ„ â†’ n2 å¯¹è±¡ ref ä» 1 å˜ä¸º 0 â†’ åˆ é™¤ n2 å¯¹è±¡ âœ…
// è¾“å‡ºä¸¤æ¬¡ "Node destroyed" âœ…
```

#### ä½¿ç”¨ weak_ptr

```cpp
auto sp = std::make_shared<int>(42);
std::weak_ptr<int> wp = sp;  // ä¸å¢åŠ å¼•ç”¨è®¡æ•°

// âŒ ä¸èƒ½ç›´æ¥è®¿é—®
// *wp;  // ç¼–è¯‘é”™è¯¯ï¼

// âœ… å¿…é¡»å…ˆ lock() è½¬ä¸º shared_ptr
if (auto temp = wp.lock()) {  // å¦‚æœå¯¹è±¡è¿˜å­˜åœ¨ï¼Œè¿”å› shared_ptr
    std::cout << *temp;       // 42
} else {
    std::cout << "å¯¹è±¡å·²é‡Šæ”¾";
}
```

#### åŒå‘å¼•ç”¨çš„å¸¸è§„ç”¨æ³•

**åœ¨åŒå‘å…³ç³»ä¸­ï¼Œéœ€è¦æ˜ç¡®"è°æ‹¥æœ‰è°"ï¼š**

```
æ‹¥æœ‰æ–¹ â†’ è¢«æ‹¥æœ‰æ–¹ï¼šç”¨ shared_ptrï¼ˆå¼ºå¼•ç”¨ï¼‰
è¢«æ‹¥æœ‰æ–¹ â†’ æ‹¥æœ‰æ–¹ï¼šç”¨ weak_ptrï¼ˆå¼±å¼•ç”¨ï¼‰
```

**å¸¸è§åœºæ™¯ï¼š**

1. **çˆ¶å­å…³ç³»**ï¼ˆæœ€å¸¸è§ï¼‰
   ```cpp
   class Child;

   class Parent {
       std::shared_ptr<Child> child;  // çˆ¶æ‹¥æœ‰å­ â†’ shared_ptr
   };

   class Child {
       std::weak_ptr<Parent> parent;  // å­å¼•ç”¨çˆ¶ â†’ weak_ptr

       void notify_parent() {
           if (auto p = parent.lock()) {  // æ£€æŸ¥çˆ¶å¯¹è±¡æ˜¯å¦è¿˜å­˜åœ¨
               p->handle_event();
           }
       }
   };
   ```

2. **é“¾è¡¨/æ ‘çš„åŒå‘æŒ‡é’ˆ**
   ```cpp
   struct TreeNode {
       std::shared_ptr<TreeNode> left;      // çˆ¶ â†’ å­ï¼šå¼ºå¼•ç”¨
       std::shared_ptr<TreeNode> right;     // çˆ¶ â†’ å­ï¼šå¼ºå¼•ç”¨
       std::weak_ptr<TreeNode> parent;      // å­ â†’ çˆ¶ï¼šå¼±å¼•ç”¨
   };
   ```

3. **è§‚å¯Ÿè€…æ¨¡å¼**
   ```cpp
   class Subject {
       std::vector<std::weak_ptr<Observer>> observers_;  // å¼±å¼•ç”¨
       // ä¸»é¢˜ä¸æ‹¥æœ‰è§‚å¯Ÿè€…ï¼Œè§‚å¯Ÿè€…å¯ä»¥éšæ—¶åˆ é™¤

       void notify() {
           for (auto it = observers_.begin(); it != observers_.end(); ) {
               if (auto obs = it->lock()) {  // è§‚å¯Ÿè€…è¿˜å­˜åœ¨
                   obs->update();
                   ++it;
               } else {
                   it = observers_.erase(it);  // è§‚å¯Ÿè€…å·²åˆ é™¤ï¼Œæ¸…ç†
               }
           }
       }
   };
   ```

**åˆ¤æ–­æ–¹æ³•**ï¼šé—®è‡ªå·±"è°çš„ç”Ÿå‘½å‘¨æœŸä¾èµ–è°ï¼Ÿ"
- A åˆ é™¤æ—¶ï¼ŒB ä¹Ÿåº”è¯¥åˆ é™¤ â†’ A ç”¨ `shared_ptr` æŒ‡å‘ Bï¼ŒB ç”¨ `weak_ptr` æŒ‡å‘ A

## é€‰æ‹©æŒ‡å—

```
éœ€è¦åŠ¨æ€å†…å­˜ï¼Ÿ
    â†“
ç‹¬å æ‰€æœ‰æƒï¼Ÿ â†’ unique_ptrï¼ˆé»˜è®¤é€‰æ‹©ï¼‰
    â†“
éœ€è¦å…±äº«ï¼Ÿ â†’ shared_ptr
    â†“
æœ‰å¾ªç¯å¼•ç”¨ï¼Ÿ â†’ weak_ptr æ‰“ç ´å¾ªç¯
```

## å¸¸è§é™·é˜±

```cpp
// âŒ ä¸è¦ç”¨åŒä¸€ä¸ªè£¸æŒ‡é’ˆåˆå§‹åŒ–å¤šä¸ªæ™ºèƒ½æŒ‡é’ˆ
int* raw = new int(42);
std::unique_ptr<int> p1(raw);
std::unique_ptr<int> p2(raw);  // é‡å¤é‡Šæ”¾

// âŒ ä¸è¦ä»æ™ºèƒ½æŒ‡é’ˆè·å–è£¸æŒ‡é’ˆåå†åˆ›å»ºæ™ºèƒ½æŒ‡é’ˆ
auto p1 = std::make_unique<int>(42);
std::unique_ptr<int> p2(p1.get());  // é‡å¤é‡Šæ”¾

// âŒ å‡½æ•°å‚æ•°ä¸è¦ä¼ å€¼ï¼ˆå¼•ç”¨è®¡æ•°å¼€é”€ï¼‰
void foo(std::shared_ptr<T> p);  // ä¸å¥½
void foo(const std::shared_ptr<T>& p);  // å¥½
void foo(T* p);  // æ›´å¥½ï¼ˆä¸éœ€è¦æ‰€æœ‰æƒæ—¶ï¼‰
```

## æœ€ä½³å®è·µ

```cpp
// 1. é»˜è®¤ç”¨ unique_ptr
auto p = std::make_unique<T>();

// 2. éœ€è¦å…±äº«æ‰ç”¨ shared_ptr
auto sp = std::make_shared<T>();

// 3. ç”¨ make_unique/make_sharedï¼ˆä¸è¦æ‰‹åŠ¨ newï¼‰
// âœ… auto p = std::make_unique<T>();
// âŒ std::unique_ptr<T> p(new T());

// 4. å‡½æ•°å‚æ•°æŒ‰éœ€ä¼ é€’
void use_only(T& obj);                    // åªä½¿ç”¨
void take_ownership(std::unique_ptr<T> p); // è½¬ç§»æ‰€æœ‰æƒ
void share(std::shared_ptr<T> p);          // å…±äº«æ‰€æœ‰æƒ
```

## æ€§èƒ½å¯¹æ¯”

| ç±»å‹ | å¤§å° | å¼€é”€ | ä½¿ç”¨åœºæ™¯ |
|-----|------|------|---------|
| unique_ptr | sizeof(T*) | é›¶å¼€é”€ | 90% çš„æƒ…å†µ |
| shared_ptr | 2*sizeof(T*) | å¼•ç”¨è®¡æ•° | éœ€è¦å…±äº« |
| weak_ptr | 2*sizeof(T*) | å° | æ‰“ç ´å¾ªç¯ |
