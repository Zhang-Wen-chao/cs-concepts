# ç°ä»£ C++ æ€ç»´è½¬å˜

> ä» C++98 åˆ° C++11/14/17/20 çš„æ€ç»´é©å‘½

## ğŸ¯ æ ¸å¿ƒæ€æƒ³ï¼šè®©ç¼–è¯‘å™¨å¸®ä½ ç®¡ç†èµ„æº

**æ—§æ€ç»´ï¼ˆC++98ï¼‰ï¼š** ç¨‹åºå‘˜æ‰‹åŠ¨ç®¡ç†ä¸€åˆ‡
- æ‰‹åŠ¨ new/delete
- æ‰‹åŠ¨åŠ é”/è§£é”
- æ‰‹åŠ¨æ‰“å¼€/å…³é—­æ–‡ä»¶
- å®¹æ˜“å¿˜è®°ï¼Œå®¹æ˜“å‡ºé”™

**æ–°æ€ç»´ï¼ˆç°ä»£ C++ï¼‰ï¼š** åˆ©ç”¨ç±»å‹ç³»ç»Ÿå’Œ RAII
- ç¼–è¯‘å™¨è‡ªåŠ¨ç®¡ç†ç”Ÿå‘½å‘¨æœŸ
- èµ„æºæ³„æ¼åœ¨ç¼–è¯‘æ—¶å°±èƒ½å‘ç°
- ä»£ç æ›´å®‰å…¨ã€æ›´ç®€æ´

---

## 1ï¸âƒ£ æœ€é‡è¦çš„è½¬å˜ï¼šä»æ‰‹åŠ¨åˆ°è‡ªåŠ¨

### æ—§ä»£ç ï¼ˆC++98ï¼‰çš„é—®é¢˜

```cpp
// âŒ æ—§é£æ ¼ï¼šå±é™©é‡é‡
void process_data() {
    int* data = new int[1000];        // åˆ†é…å†…å­˜

    // ... å¤„ç†æ•°æ® ...

    if (error_condition) {
        return;  // ğŸ’¥ å†…å­˜æ³„æ¼ï¼å¿˜è®° delete[]
    }

    delete[] data;  // åªæœ‰æ­£å¸¸æµç¨‹æ‰ä¼šæ‰§è¡Œ
}
```

**é—®é¢˜ï¼š**
- å®¹æ˜“å¿˜è®°é‡Šæ”¾èµ„æº
- å¼‚å¸¸ä¼šå¯¼è‡´èµ„æºæ³„æ¼
- å¤šä¸ª return è·¯å¾„ï¼Œæ¯ä¸ªéƒ½è¦è®°å¾—æ¸…ç†
- ä»£ç å¤æ‚ï¼Œç»´æŠ¤å›°éš¾

### ç°ä»£ä»£ç ï¼ˆC++11+ï¼‰çš„è§£å†³æ–¹æ¡ˆ

```cpp
// âœ… ç°ä»£é£æ ¼ï¼šè‡ªåŠ¨ç®¡ç†
void process_data() {
    std::vector<int> data(1000);  // è‡ªåŠ¨åˆ†é…

    // ... å¤„ç†æ•°æ® ...

    if (error_condition) {
        return;  // âœ… æ²¡é—®é¢˜ï¼è‡ªåŠ¨é‡Šæ”¾
    }

    // âœ… å‡½æ•°ç»“æŸæ—¶è‡ªåŠ¨é‡Šæ”¾
}
```

**ä¼˜åŠ¿ï¼š**
- ä¸å¯èƒ½å¿˜è®°é‡Šæ”¾ï¼ˆç¼–è¯‘å™¨ä¿è¯ï¼‰
- å¼‚å¸¸å®‰å…¨ï¼ˆè‡ªåŠ¨æ¸…ç†ï¼‰
- ä»»ä½• return è·¯å¾„éƒ½å®‰å…¨
- ä»£ç ç®€æ´æ¸…æ™°

---

## 2ï¸âƒ£ RAIIï¼šç°ä»£ C++ çš„åŸºçŸ³

**RAII = Resource Acquisition Is Initializationï¼ˆèµ„æºè·å–å³åˆå§‹åŒ–ï¼‰**

> âš ï¸ è¿™ä¸ªç¿»è¯‘å¾ˆçƒ‚ï¼æ›´å¥½çš„ç†è§£æ˜¯ï¼š**èµ„æºçš„ç”Ÿå‘½å‘¨æœŸç»‘å®šåˆ°å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸ**

**æ ¸å¿ƒæ€æƒ³ï¼š**
- æ„é€ å‡½æ•°ï¼šè·å–èµ„æº
- ææ„å‡½æ•°ï¼šé‡Šæ”¾èµ„æº
- C++ ä¿è¯ï¼šå¯¹è±¡ç¦»å¼€ä½œç”¨åŸŸæ—¶ï¼Œä¸€å®šä¼šè°ƒç”¨ææ„å‡½æ•°

```cpp
class File {
public:
    File(const std::string& filename)
        : file_(fopen(filename.c_str(), "r")) {  // æ„é€ æ—¶è·å–èµ„æº
        if (!file_) throw std::runtime_error("Cannot open file");
    }

    ~File() {
        if (file_) fclose(file_);  // ææ„æ—¶é‡Šæ”¾èµ„æº
    }

    // ç¦æ­¢æ‹·è´ï¼ˆé˜²æ­¢é‡å¤é‡Šæ”¾ï¼‰
    File(const File&) = delete;
    File& operator=(const File&) = delete;

private:
    FILE* file_;
};

// ä½¿ç”¨ï¼š
void read_file() {
    File f("data.txt");  // è‡ªåŠ¨æ‰“å¼€
    // ... è¯»å–æ–‡ä»¶ ...
}  // è‡ªåŠ¨å…³é—­ï¼Œå³ä½¿æœ‰å¼‚å¸¸ä¹Ÿä¼šå…³é—­
```

---

## 3ï¸âƒ£ æ™ºèƒ½æŒ‡é’ˆï¼šå‘Šåˆ«è£¸æŒ‡é’ˆ

### é—®é¢˜ï¼šè£¸æŒ‡é’ˆçš„ä¸‰å¤§ç½ª

```cpp
// âŒ ç½ªçŠ¶ 1ï¼šæ‰€æœ‰æƒä¸æ¸…æ™°
void foo(int* p);  // è°è´Ÿè´£ deleteï¼Ÿä¸çŸ¥é“ï¼

// âŒ ç½ªçŠ¶ 2ï¼šå®¹æ˜“å¿˜è®°é‡Šæ”¾
int* p = new int(10);
// ... 100 è¡Œä»£ç å ...
// å¿˜è®° delete p; ğŸ’¥

// âŒ ç½ªçŠ¶ 3ï¼šæ‚¬ç©ºæŒ‡é’ˆ
int* p = new int(10);
delete p;
*p = 20;  // ğŸ’¥ è®¿é—®å·²é‡Šæ”¾çš„å†…å­˜
```

### è§£å†³æ–¹æ¡ˆï¼šæ™ºèƒ½æŒ‡é’ˆ

```cpp
// âœ… ç‹¬å æ‰€æœ‰æƒï¼šstd::unique_ptr
std::unique_ptr<int> p = std::make_unique<int>(10);
// è‡ªåŠ¨é‡Šæ”¾ï¼Œä¸ä¼šæ³„æ¼
// ä¸èƒ½æ‹·è´ï¼Œæ‰€æœ‰æƒæ¸…æ™°

// âœ… å…±äº«æ‰€æœ‰æƒï¼šstd::shared_ptr
std::shared_ptr<int> p1 = std::make_shared<int>(10);
std::shared_ptr<int> p2 = p1;  // å¼•ç”¨è®¡æ•° +1
// æœ€åä¸€ä¸ª shared_ptr é”€æ¯æ—¶æ‰é‡Šæ”¾

// âœ… å¼±å¼•ç”¨ï¼šstd::weak_ptrï¼ˆæ‰“ç ´å¾ªç¯å¼•ç”¨ï¼‰
std::weak_ptr<int> wp = p1;  // ä¸å¢åŠ å¼•ç”¨è®¡æ•°
```

**90% çš„æƒ…å†µç”¨ `unique_ptr`ï¼Œåªåœ¨éœ€è¦å…±äº«æ—¶ç”¨ `shared_ptr`**

---

## 4ï¸âƒ£ æ ‡å‡†å®¹å™¨ï¼šä¸è¦é‡å¤é€ è½®å­

### å¸¸ç”¨å®¹å™¨

```cpp
// åŠ¨æ€æ•°ç»„
std::vector<int> vec = {1, 2, 3, 4, 5};

// å“ˆå¸Œè¡¨
std::unordered_map<std::string, int> map;
map["apple"] = 5;

// é›†åˆ
std::unordered_set<int> set = {1, 2, 3};

// å­—ç¬¦ä¸²ï¼ˆä¹Ÿæ˜¯å®¹å™¨ï¼ï¼‰
std::string str = "hello";
```

**ä¸ºä»€ä¹ˆä¸æ‰‹å†™ï¼Ÿ**
- æ ‡å‡†åº“ç»è¿‡å……åˆ†æµ‹è¯•
- æ€§èƒ½ä¼˜åŒ–åˆ°æè‡´
- å¼‚å¸¸å®‰å…¨
- æ¥å£ç»Ÿä¸€

---

## 5ï¸âƒ£ ç§»åŠ¨è¯­ä¹‰ï¼šæ€§èƒ½é©å‘½

**é—®é¢˜ï¼šæ‹·è´å¤§å¯¹è±¡å¾ˆæ…¢**

```cpp
// âŒ æ—§ä»£ç ï¼šæ‹·è´å¼€é”€å¤§
std::vector<int> create_large_vector() {
    std::vector<int> vec(1000000);
    return vec;  // æ‹·è´ 100 ä¸‡ä¸ªå…ƒç´ ï¼Ÿ
}

std::vector<int> v = create_large_vector();  // åˆæ‹·è´ä¸€æ¬¡ï¼Ÿ
```

**ç°ä»£ C++ï¼šç§»åŠ¨è¯­ä¹‰**

```cpp
// âœ… ç°ä»£ C++ï¼šè‡ªåŠ¨ç§»åŠ¨ï¼Œä¸æ‹·è´
std::vector<int> create_large_vector() {
    std::vector<int> vec(1000000);
    return vec;  // âœ… ç§»åŠ¨ï¼Œä¸æ‹·è´ï¼ˆO(1)ï¼‰
}

std::vector<int> v = create_large_vector();  // âœ… ç§»åŠ¨ï¼Œä¸æ‹·è´
```

**ç§»åŠ¨ vs æ‹·è´ï¼š**
- æ‹·è´ï¼šå¤åˆ¶æ‰€æœ‰æ•°æ®ï¼ˆæ…¢ï¼‰
- ç§»åŠ¨ï¼šè½¬ç§»æ‰€æœ‰æƒï¼Œåªæ‹·è´æŒ‡é’ˆï¼ˆå¿«ï¼‰

---

## 6ï¸âƒ£ Lambda è¡¨è¾¾å¼ï¼šå‡½æ•°å¼ç¼–ç¨‹

**æ—§é£æ ¼ï¼šå®šä¹‰å‘½åå‡½æ•°**

```cpp
// âŒ å•°å—¦
bool is_even(int x) { return x % 2 == 0; }

std::vector<int> vec = {1, 2, 3, 4, 5};
auto it = std::find_if(vec.begin(), vec.end(), is_even);
```

**ç°ä»£é£æ ¼ï¼šLambda**

```cpp
// âœ… ç®€æ´
std::vector<int> vec = {1, 2, 3, 4, 5};
auto it = std::find_if(vec.begin(), vec.end(),
                       [](int x) { return x % 2 == 0; });
```

**æ›´å¼ºå¤§ï¼šæ•è·å¤–éƒ¨å˜é‡**

```cpp
int threshold = 10;
auto is_large = [threshold](int x) {
    return x > threshold;
};
```

---

## 7ï¸âƒ£ ç±»å‹æ¨å¯¼ï¼šè®©ç¼–è¯‘å™¨æ¨å¯¼ç±»å‹

```cpp
// âŒ å†—é•¿
std::unordered_map<std::string, std::vector<int>>::iterator it = map.begin();

// âœ… ç®€æ´
auto it = map.begin();

// âœ… æ›´ç®€æ´ï¼ˆC++11 èŒƒå›´ forï¼‰
for (const auto& [key, value] : map) {  // C++17 ç»“æ„åŒ–ç»‘å®š
    std::cout << key << ": " << value << "\n";
}
```

---

## 8ï¸âƒ£ const æ­£ç¡®æ€§ï¼šæ„å›¾æ˜ç¡®

```cpp
// âŒ ä¸æ¸…æ¥š
void process(std::string& str);  // ä¼šä¿®æ”¹å—ï¼Ÿä¸çŸ¥é“ï¼

// âœ… æ„å›¾æ˜ç¡®
void read_only(const std::string& str);   // ä¸ä¼šä¿®æ”¹
void modify(std::string& str);             // ä¼šä¿®æ”¹
void take_ownership(std::string&& str);    // ç§»åŠ¨è¯­ä¹‰
```

**åŸåˆ™ï¼šèƒ½åŠ  const å°±åŠ  const**

---

## 9ï¸âƒ£ å¼‚å¸¸å®‰å…¨ï¼šä¿è¯ä¸€è‡´æ€§

### ä¸‰ä¸ªç­‰çº§

**1. åŸºæœ¬ä¿è¯ï¼š** ä¸æ³„æ¼èµ„æº
```cpp
void foo() {
    std::vector<int> vec;  // å¼‚å¸¸æ—¶è‡ªåŠ¨æ¸…ç†
    // ...
}
```

**2. å¼ºä¿è¯ï¼š** è¦ä¹ˆæˆåŠŸï¼Œè¦ä¹ˆä¸å˜ï¼ˆäº‹åŠ¡æ€§ï¼‰
```cpp
void push_back_strong(std::vector<T>& vec, const T& value) {
    auto temp = vec;  // å¤‡ä»½
    temp.push_back(value);  // å¯èƒ½æŠ›å¼‚å¸¸
    vec = std::move(temp);  // ä¸ä¼šæŠ›å¼‚å¸¸
}
```

**3. ä¸æŠ›ä¿è¯ï¼š** ä¿è¯ä¸æŠ›å¼‚å¸¸ï¼ˆç§»åŠ¨æ„é€ å‡½æ•°ã€ææ„å‡½æ•°ï¼‰
```cpp
class Widget {
    Widget(Widget&& other) noexcept;  // ä¿è¯ä¸æŠ›å¼‚å¸¸
};
```

---

## ğŸ¯ æ€»ç»“ï¼šç°ä»£ C++ çš„æ ¸å¿ƒåŸåˆ™

### 1. è®©ç¼–è¯‘å™¨å¸®ä½ ç®¡ç†èµ„æºï¼ˆRAIIï¼‰
- ä¸æ‰‹åŠ¨ new/delete
- ç”¨æ™ºèƒ½æŒ‡é’ˆ
- ç”¨æ ‡å‡†å®¹å™¨

### 2. æ˜ç¡®æ‰€æœ‰æƒ
- `unique_ptr`ï¼šç‹¬å 
- `shared_ptr`ï¼šå…±äº«
- å¼•ç”¨ï¼šä¸æ‹¥æœ‰

### 3. é¿å…æ‹·è´ï¼Œæ‹¥æŠ±ç§»åŠ¨
- è¿”å›å¤§å¯¹è±¡ï¼šç¼–è¯‘å™¨è‡ªåŠ¨ä¼˜åŒ–
- éœ€è¦è½¬ç§»æ‰€æœ‰æƒï¼š`std::move()`

### 4. const æ­£ç¡®æ€§
- èƒ½ const å°± const
- å‚æ•°ä¼  const å¼•ç”¨

### 5. ä½¿ç”¨æ ‡å‡†åº“
- ä¸é‡å¤é€ è½®å­
- å®¹å™¨ã€ç®—æ³•ã€æ™ºèƒ½æŒ‡é’ˆéƒ½ç”¨æ ‡å‡†åº“

---

## ğŸ“ å®è·µï¼šå¯¹æ¯”æ–°æ—§ä»£ç 

### ç»ƒä¹  1ï¼šæ–‡ä»¶å¤„ç†

**æ—§ä»£ç ï¼ˆC++98ï¼‰ï¼š**
```cpp
void process_file(const char* filename) {
    FILE* f = fopen(filename, "r");
    if (!f) return;

    char* buffer = new char[1024];

    // ... å¤„ç†æ–‡ä»¶ ...

    // ğŸ’¥ å¦‚æœè¿™é‡ŒæŠ›å¼‚å¸¸æ€ä¹ˆåŠï¼Ÿ

    delete[] buffer;
    fclose(f);
}
```

**ç°ä»£ä»£ç ï¼ˆC++11+ï¼‰ï¼š**
```cpp
void process_file(const std::string& filename) {
    std::ifstream file(filename);  // RAIIï¼šè‡ªåŠ¨å…³é—­
    if (!file) return;

    std::vector<char> buffer(1024);  // RAIIï¼šè‡ªåŠ¨é‡Šæ”¾

    // ... å¤„ç†æ–‡ä»¶ ...

    // âœ… å¼‚å¸¸å®‰å…¨ï¼è‡ªåŠ¨æ¸…ç†
}
```

### ç»ƒä¹  2ï¼šæ•°æ®å®¹å™¨

**æ—§ä»£ç ï¼š**
```cpp
class IntArray {
    int* data_;
    size_t size_;

public:
    IntArray(size_t size) : size_(size) {
        data_ = new int[size];  // æ‰‹åŠ¨ç®¡ç†
    }

    ~IntArray() {
        delete[] data_;  // å®¹æ˜“å¿˜è®°
    }

    // è¿˜è¦å†™æ‹·è´æ„é€ ã€èµ‹å€¼è¿ç®—ç¬¦...
};
```

**ç°ä»£ä»£ç ï¼š**
```cpp
// âœ… ç›´æ¥ç”¨æ ‡å‡†åº“
using IntArray = std::vector<int>;

// æˆ–è€…æ›´å¼ºçš„ç±»å‹å®‰å…¨ï¼š
class IntArray {
    std::vector<int> data_;  // è‡ªåŠ¨ç®¡ç†

public:
    IntArray(size_t size) : data_(size) {}
    // ç¼–è¯‘å™¨è‡ªåŠ¨ç”Ÿæˆæ‹·è´ã€ç§»åŠ¨ã€ææ„
};
```

---

## ğŸš€ ä¸‹ä¸€æ­¥

ç†è§£äº†ç°ä»£ C++ çš„æ€ç»´æ–¹å¼åï¼Œæ¥ä¸‹æ¥æ·±å…¥å­¦ä¹ ï¼š
1. **RAII åŸåˆ™**ï¼ˆä¸‹ä¸€ç« ï¼‰
2. æ™ºèƒ½æŒ‡é’ˆçš„è¯¦ç»†ç”¨æ³•
3. æ ‡å‡†å®¹å™¨çš„é€‰æ‹©
4. ç§»åŠ¨è¯­ä¹‰çš„åŸç†

**è®°ä½ï¼šç°ä»£ C++ çš„ç›®æ ‡æ˜¯è®©ä½ å†™å‡ºæ—¢é«˜æ•ˆåˆå®‰å…¨çš„ä»£ç ï¼**

---

## ğŸ’» é…å¥—å®è·µä»£ç 

**è¿è¡Œç¤ºä¾‹ä»£ç ï¼š**
```bash
cd practices
g++ -std=c++17 00_old_vs_new_cpp.cpp -o old_vs_new
./old_vs_new
```

ä»£ç åŒ…å« 10 ä¸ªå®Œæ•´ç¤ºä¾‹ï¼Œå±•ç¤ºæ–°æ—§ C++ çš„å¯¹æ¯”ã€‚
